<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Infinite Loading Screen</title>
    <style>
      #failCounter1, #failCounter2, #failCounter3{display: none;}
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #fff;
            overflow: hidden;
        }
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        .spinner {
            width: 80px;
            height: 80px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 40px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
        .captcha-fake {
            display: flex;
            flex-direction: row;
            align-items: center;
            background: #f9f9f9;
            border: 1px solid #d3d3d3;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            padding: 12px 18px 12px 12px;
            min-width: 320px;
            min-height: 80px;
            position: relative;
            cursor: pointer;
            user-select: none;
            transition: box-shadow 0.2s;
        }
        .captcha-fake:active {
            box-shadow: 0 2px 16px rgba(66,133,244,0.15);
        }
        .captcha-checkbox {
            width: 28px;
            height: 28px;
            border: 2px solid #c1c1c1;
            border-radius: 3px;
            background: #fff;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #4285f4;
            transition: border-color 0.2s;
        }
        .captcha-checkbox.checked {
            border-color: #4285f4;
            background: #e8f0fe;
        }
        .captcha-fake-label {
            font-size: 16px;
            color: #222;
            font-family: Arial, sans-serif;
            margin-right: 18px;
        }
        .captcha-fake-logo {
            width: 32px;
            height: 32px;
            margin-left: auto;
        }
        .captcha-fake-x {
            display: none;
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 22px;
            color: #888;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 2;
        }
        .captcha-fake-x:hover {
            color: #222;
        }
        .captcha-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.35);
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .captcha-window {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.2);
            width: 370px;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            position: relative;
        }
        .captcha-header {
            background: #f9f9f9;
            padding: 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        .captcha-logo {
            width: 32px;
            height: 32px;
            margin-right: 12px;
        }
        .captcha-title {
            font-size: 16px;
            color: #222;
            font-weight: bold;
        }
        .captcha-content {
            padding: 24px 16px 16px 16px;
            text-align: center;
        }
        .maze-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .maze {
            display: grid;
            grid-template-columns: repeat(15, 16px);
            grid-template-rows: repeat(15, 16px);
            gap: 2px;
            margin: 0 auto;
        }
        .maze-cell {
            width: 16px;
            height: 16px;
            background: #e0e0e0;
            border-radius: 4px;
        }
        .maze-wall {
            background: #757575;
        }
        .maze-player {
            background: #4285f4;
        }
        .maze-end {
            background: #34a853;
        }
        .captcha-close {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            font-size: 20px;
            color: #888;
            cursor: pointer;
        }
        .captcha-close:hover {
            color: #222;
        }
        .captcha-footer {
            padding: 12px 16px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
            text-align: right;
        }
        .captcha-success {
            color: #34a853;
            font-weight: bold;
            margin-top: 12px;
        }
        .captcha-fail {
            color: #ea4335;
            font-weight: bold;
            margin-top: 12px;
        }
        #tttRestart {
            display: none;
            margin: 18px auto 0 auto;
            padding: 0 28px;
            height: 36px;
            background: #f1f3f4;
            color: #222;
            border: 1px solid #d3d3d3;
            border-radius: 4px;
            font-size: 15px;
            font-family: Arial, sans-serif;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(60,64,67,0.08);
            transition: background 0.2s, border-color 0.2s;
            display: block;
        }
        #tttRestart:hover {
            background: #e8f0fe;
            border-color: #4285f4;
            color: #174ea6;
        }
        .final-btn {
            background: #f1f3f4;
            color: #222;
            border: 1px solid #d3d3d3;
            border-radius: 4px;
            font-size: 15px;
            font-family: Arial, sans-serif;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(60,64,67,0.08);
            transition: background 0.2s, border-color 0.2s, left 0.2s, top 0.2s;
            height: 38px;
            margin: 0 auto;
            display: block;
            min-width: 120px;
        }
        .final-btn:hover {
            background: #e8f0fe;
            border-color: #4285f4;
            color: #174ea6;
        }
        #captchaFinalModal .captcha-content > div[style*="flex"] {
            position: relative;
            min-height: 120px;
        }
        #btnHuman {
            position: absolute;
            transition: background 0s;
            /* решта стилів залишаються як у вас */
        }
    </style>
</head>
<body>
    <div id="mainContainer" style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100vw;height:100vh;">
        <div id="spinnerBox">
            <div class="spinner"></div>
        </div>
        <div id="captchaFake" class="captcha-fake" tabindex="0" style="display:none;">
            <div id="captchaCheckbox" class="captcha-checkbox"></div>
            <span class="captcha-fake-label">I'm not a robot</span>
            <img class="captcha-fake-logo" src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA">
        </div>
    </div>
    <div class="captcha-modal" id="captchaModal">
        <div class="captcha-window">
            <button class="captcha-close" id="closeCaptcha" aria-label="Close">&times;</button>
            <div class="captcha-header">
                <img class="captcha-logo" src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA">
                <div class="captcha-title">I'm not a robot</div>
                <div id="failCounter1" style="position:absolute;top:10px;right:16px;font-size:13px;color:#ea4335;font-weight:bold;">Fails: 0</div>
            </div>
            <div class="captcha-content">
                <div style="font-size:13px;color:#555;margin-bottom:10px;">Navigate the blue square to the green square using arrow keys or AWSD.</div>
                <div class="maze-container">
                    <div class="maze" id="maze"></div>
                </div>
                <div id="captchaSuccess" class="captcha-success" style="display:none;">Success!</div>
                <div id="captchaFail" class="captcha-fail" style="display:none;">You've lost. Try one more time.</div>
            </div>
            <div class="captcha-footer">
                <span style="font-size:11px;color:#888;">This page is protected by reCAPTCHA</span>
            </div>
        </div>
    </div>
    <div class="captcha-modal" id="captchaSimonModal" style="display:none;">
        <div class="captcha-window">
            <button class="captcha-close" id="closeSimon" aria-label="Close">&times;</button>
            <div class="captcha-header">
                <img class="captcha-logo" src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA">
                <div class="captcha-title">Memory Signal Puzzle</div>
                <div id="failCounter2" style="position:absolute;top:10px;right:16px;font-size:13px;color:#ea4335;font-weight:bold;">Fails: 0</div>
            </div>
            <div class="captcha-content">
                <div style="font-size:13px;color:#555;margin-bottom:10px;">
                    Remember the sequence! Repeat the pattern by clicking the squares in the same order.
                </div>
                <div id="simonGrid" style="display:grid;grid-template-columns:repeat(3,48px);grid-template-rows:repeat(3,48px);gap:10px;justify-content:center;margin:0 auto 10px auto;"></div>
                <div id="simonStatus" style="font-size:15px;color:#34a853;display:none;margin-top:10px;">You win!</div>
                <div id="simonFail" style="font-size:15px;color:#ea4335;display:none;margin-top:10px;">Wrong! Try again.</div>
                <button id="simonRestart" style="display:none;margin-top:10px;">Restart</button>
            </div>
            <div class="captcha-footer">
                <span style="font-size:11px;color:#888;">This page is protected by reCAPTCHA</span>
            </div>
        </div>
    </div>
    <div class="captcha-modal" id="captchaTicTacToeModal" style="display:none;">
        <div class="captcha-window">
            <button class="captcha-close" id="closeTicTacToe" aria-label="Close">&times;</button>
            <div class="captcha-header" style="position:relative;">
                <img class="captcha-logo" src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA">
                <div class="captcha-title">Tic-Tac-Toe</div>
                <div id="failCounter3"
                    style="display:none;position:absolute;top:44px;right:16px;font-size:13px;color:#ea4335;font-weight:bold;z-index:2;">
                    Fails: 0
                </div>
            </div>
            <div class="captcha-content">
                <div style="font-size:13px;color:#555;margin-bottom:10px;">
                    Win against the AI in 3 attempts! You start first. In case of a draw, the starter switches.
                </div>
                <div id="tttGrid" style="display:grid;grid-template-columns:repeat(3,48px);grid-template-rows:repeat(3,48px);gap:10px;justify-content:center;margin:0 auto 10px auto;"></div>
                <div id="tttStatus" style="font-size:15px;color:#34a853;display:none;margin-top:10px;"></div>
                <div id="tttFail" style="font-size:15px;color:#ea4335;display:none;margin-top:10px;"></div>
                <button id="tttRestart" style="display:none;margin-top:10px;">Next round</button>
            </div>
            <div class="captcha-footer">
                <span style="font-size:11px;color:#888;">This page is protected by reCAPTCHA</span>
            </div>
        </div>
    </div>
    <div class="captcha-modal" id="captchaFinalModal" style="display:none;">
        <div class="captcha-window">
            <button class="captcha-close" id="closeFinal" aria-label="Close">&times;</button>
            <div class="captcha-header">
                <img class="captcha-logo" src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA">
                <div class="captcha-title">Final Check</div>
            </div>
            <div class="captcha-content">
                <div style="font-size:16px;color:#222;font-weight:bold;margin-bottom:24px;">Are you a human?</div>
                <div style="display:flex;flex-direction:column;align-items:center;gap:18px;">
                    <button id="btnRobot" class="final-btn" style="width:180px;">I am robot</button>
                    <button id="btnHuman" class="final-btn" style="width:180px;position:relative;">I am human</button>
                </div>
            </div>
            <div class="captcha-footer">
                <span style="font-size:11px;color:#888;">This page is protected by reCAPTCHA</span>
            </div>
        </div>
    </div>

    <script>
        // Управління WASD (UA/EN) та ФЦІВ (UA)
        const moveKeys = {
            // English
            'w': {dx:0, dy:-1},   // W - вгору
            'a': {dx:-1, dy:0},   // A - вліво
            's': {dx:0, dy:1},    // S - вниз
            'd': {dx:1, dy:0},    // D - вправо
            // Українська ФЦІВ
            'ф': {dx:-1, dy:0},   // Ф - вліво
            'ц': {dx:0, dy:-1},   // Ц - вгору
            'і': {dx:0, dy:1},    // І - вниз
            'в': {dx:1, dy:0},    // В - вправо
        };
        // Генерація лабіринту
        function generateMaze(width, height) {
            let maze = Array.from({length: height}, () => Array(width).fill(0));
            function carve(x, y) {
                maze[y][x] = 1;
                const dirs = [
                    [0, -2], [0, 2], [-2, 0], [2, 0]
                ].sort(() => Math.random() - 0.5);
                for (const [dx, dy] of dirs) {
                    const nx = x + dx, ny = y + dy;
                    if (ny > 0 && ny < height && nx > 0 && nx < width && maze[ny][nx] === 0) {
                        maze[y + dy/2][x + dx/2] = 1;
                        carve(nx, ny);
                    }
                }
            }
            carve(1, 1);
            maze[1][1] = 2;
            maze[height-2][width-2] = 3;
            return maze;
        }

        // Менший лабіринт
        const MAZE_SIZE = 21;
        let mazeData = generateMaze(MAZE_SIZE, MAZE_SIZE);
        let playerPos = {x:1, y:1};

        function findStart() {
            for(let y=0; y<mazeData.length; y++) {
                for(let x=0; x<mazeData[0].length; x++) {
                    if(mazeData[y][x] === 2) return {x, y};
                }
            }
            return {x:1, y:1};
        }

        function drawMaze() {
            const maze = document.getElementById('maze');
            maze.innerHTML = '';
            let viewSize = 15;
            let half = Math.floor(viewSize/2);
            let startY = Math.max(0, playerPos.y - half);
            let startX = Math.max(0, playerPos.x - half);
            maze.style.gridTemplateColumns = `repeat(${viewSize}, 16px)`;
            maze.style.gridTemplateRows = `repeat(${viewSize}, 16px)`;
            for(let y=0; y<viewSize; y++) {
                for(let x=0; x<viewSize; x++) {
                    let mx = startX + x, my = startY + y;
                    const cell = document.createElement('div');
                    cell.classList.add('maze-cell');
                    if (my >= mazeData.length || mx >= mazeData[0].length) {
                        cell.classList.add('maze-wall');
                    } else {
                        if(mazeData[my][mx] === 0) cell.classList.add('maze-wall');
                        if(mazeData[my][mx] === 3) cell.classList.add('maze-end');
                        if(playerPos.x === mx && playerPos.y === my) cell.classList.add('maze-player');
                    }
                    maze.appendChild(cell);
                }
            }
        }

        function updateMaze() {
            drawMaze();
        }

        // --- Лабіринт: якщо торкнувся стінки — фейл і старт з початку ---
        function isValidMove(x, y) {
            return x >= 0 && y >= 0 && y < mazeData.length && x < mazeData[0].length && mazeData[y][x] !== 0;
        }

        function movePlayerTo(x, y) {
            if (mazeData[y][x] === 0) {
                // Торкнувся стінки — фейл і рестарт
                document.getElementById('captchaFail').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('captchaFail').style.display = 'none';
                    playerPos = findStart();
                    drawMaze();
                }, 900);
                return false;
            } else {
                playerPos.x = x;
                playerPos.y = y;
                updateMaze();
                checkWin();
                return true;
            }
        }

        function checkWin() {
            if(mazeData[playerPos.y][playerPos.x] === 3) {
                document.getElementById('captchaSuccess').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('captchaModal').style.display = 'none';
                    isModalActive = false;
                    // Відкрити Simon/Memory Game
                    document.getElementById('captchaSimonModal').style.display = 'flex';
                    startSimonGame();
                }, 1000);
            }
        }

        // Лічильники програшів
        let failCount1 = 0, failCount2 = 0, failCount3 = 0;

        function updateFailCounters() {
            document.getElementById('failCounter1').textContent = `Fails: ${failCount1}`;
            document.getElementById('failCounter2').textContent = `Fails: ${failCount2}`;
            document.getElementById('failCounter3').textContent = `Fails: ${failCount3}`;
        }

        // --- Лабіринт: першим ходить бот ---
        // Для лабіринту це просто: гравець стартує, але можна додати затримку перед появою гравця, якщо треба.
        // (В даній реалізації просто стартує гравець, бо бот не потрібен.)

        // --- Лабіринт: програш = перезавантаження ---
        function failCaptcha() {
            failCount1++;
            updateFailCounters();
            document.getElementById('captchaFail').style.display = 'block';
            setTimeout(() => {
                location.reload();
            }, 1200);
        }

        // --- Simon: програш = перезавантаження ---
        function simonFailReload() {
            failCount2++;
            updateFailCounters();
            document.getElementById('simonFail').style.display = 'block';
            setTimeout(() => {
                location.reload();
            }, 1200);
        }

        // --- Simon/Memory Game ---
        let simonSequence = [];
        let simonStep = 0;
        let simonActive = false;
        let simonClickable = false;
        const simonGrid = [];
        const simonColors = [
            "#e0e0e0", "#e0e0e0", "#e0e0e0",
            "#e0e0e0", "#e0e0e0", "#e0e0e0",
            "#e0e0e0", "#e0e0e0", "#e0e0e0"
        ];
        const simonActiveColor = "#4285f4"; // синій для миготіння

        function randomSimonCell() {
            return Math.floor(Math.random() * 9);
        }

        function startSimonGame() {
            // Reset
            simonSequence = [randomSimonCell()];
            simonStep = 0;
            simonActive = true;
            document.getElementById('simonStatus').style.display = 'none';
            document.getElementById('simonFail').style.display = 'none';
            document.getElementById('simonRestart').style.display = 'none';
            drawSimonGrid();
            showSimonSequence();
        }

        // --- ОБМЕЖЕННЯ НА 6 КЛІПАНЬ ---
        function showSimonSequence() {
            simonClickable = false;
            let i = 0;
            // Підрахунок кліпань для кожного квадратика
            let clickCounts = Array(9).fill(0);
            for (let idx of simonSequence) clickCounts[idx]++;
            // Якщо вже 6 кліпань — не додаємо новий
            if (simonSequence.length > 1) {
                let totalClips = simonSequence.length;
                if (totalClips >= 6) {
                    // Гра завершена перемогою
                    document.getElementById('simonStatus').textContent = "You win!";
                    document.getElementById('simonStatus').style.display = 'block';
                    simonActive = false;
                    // Замість рестарту одразу відкриваємо хрестики-нолики
                    setTimeout(() => {
                        document.getElementById('captchaSimonModal').style.display = 'none';
                        openTicTacToeAfterSimon();
                    }, 1200);
                    return;
                }
            }
            function highlight() {
                if(i < simonSequence.length) {
                    let idx = simonSequence[i];
                    simonGrid[idx].style.background = simonActiveColor; // СИНІЙ!
                    setTimeout(() => {
                        simonGrid[idx].style.background = simonColors[idx];
                        i++;
                        setTimeout(highlight, 250);
                    }, 400);
                } else {
                    simonClickable = true;
                }
            }
            setTimeout(highlight, 400);
        }

        function drawSimonGrid() {
            const grid = document.getElementById('simonGrid');
            grid.innerHTML = '';
            simonGrid.length = 0;
            for(let i=0;i<9;i++) {
                const cell = document.createElement('div');
                cell.style.width = "48px";
                cell.style.height = "48px";
                cell.style.background = simonColors[i];
                cell.style.borderRadius = "8px";
                cell.style.cursor = simonClickable ? "pointer" : "default";
                cell.style.boxShadow = "0 1px 4px rgba(0,0,0,0.08)";
                cell.addEventListener('click', () => {
                    if(!simonClickable || !simonActive) return;
                    if(i === simonSequence[simonStep]) {
                        cell.style.background = simonActiveColor;
                        setTimeout(() => {
                            cell.style.background = simonColors[i];
                        }, 200);
                        simonStep++;
                        if(simonStep === simonSequence.length) {
                            let clickCounts = Array(9).fill(0);
                            for (let idx of simonSequence) clickCounts[idx]++;
                            let totalClips = simonSequence.length;
                            if (totalClips >= 6) {
                                document.getElementById('simonStatus').textContent = "You win!";
                                document.getElementById('simonStatus').style.display = 'block';
                                simonActive = false;
                                setTimeout(() => {
                                    document.getElementById('captchaSimonModal').style.display = 'none';
                                    openTicTacToeAfterSimon();
                                }, 1200);
                            } else {
                                simonStep = 0;
                                simonSequence.push(randomSimonCell());
                                setTimeout(showSimonSequence, 700);
                            }
                        }
                    } else {
                        simonFailReload();
                    }
                });
                simonGrid.push(cell);
                grid.appendChild(cell);
            }
        }

        document.getElementById('simonRestart').onclick = startSimonGame;
        document.getElementById('closeSimon').onclick = function() {
            document.getElementById('captchaSimonModal').style.display = 'none';
            simonActive = false;
        };

        // --- Tic-Tac-Toe ---
        let tttBoard, tttHuman, tttAI, tttCurrent, tttAttempts, tttHumanWins, tttStarter, tttGameActive;

        function resetTicTacToe(starter = "ai") { // Першим ходить бот
            tttBoard = Array(9).fill("");
            tttHuman = "X";
            tttAI = "O";
            tttCurrent = starter;
            tttStarter = starter;
            tttGameActive = true;
            document.getElementById('tttStatus').style.display = 'none';
            document.getElementById('tttFail').style.display = 'none';
            document.getElementById('tttRestart').style.display = 'none';
            updateFailCounters();
            drawTicTacToe();
            if (tttCurrent === "ai") setTimeout(aiMove, 400);
        }

        function drawTicTacToe() {
            const grid = document.getElementById('tttGrid');
            grid.innerHTML = '';
            for(let i=0;i<9;i++) {
                const cell = document.createElement('div');
                cell.style.width = "48px";
                cell.style.height = "48px";
                cell.style.background = "#e0e0e0";
                cell.style.borderRadius = "8px";
                cell.style.cursor = (tttCurrent === "human" && tttBoard[i] === "" && tttGameActive) ? "pointer" : "default";
                cell.style.boxShadow = "0 1px 4px rgba(0,0,0,0.08)";
                cell.style.display = "flex";
                cell.style.alignItems = "center";
                cell.style.justifyContent = "center";
                cell.style.fontSize = "32px";
                cell.style.fontWeight = "bold";
                // Кольори: X - червоний, O - синій
                if (tttBoard[i] === "X") {
                    cell.style.color = "#ea4335";
                } else if (tttBoard[i] === "O") {
                    cell.style.color = "#4285f4";
                } else {
                    cell.style.color = "#222";
                }
                cell.textContent = tttBoard[i];
                cell.addEventListener('click', () => {
                    if(tttCurrent !== "human" || tttBoard[i] !== "" || !tttGameActive) return;
                    tttBoard[i] = tttHuman;
                    tttCurrent = "ai";
                    drawTicTacToe();
                    if(checkTicTacToeWin(tttHuman)) {
                        tttHumanWins++;
                        tttGameActive = false;
                        document.getElementById('tttStatus').textContent = `You win! (${tttHumanWins}/${tttAttempts} wins)`;
                        document.getElementById('tttStatus').style.display = 'block';
                        document.getElementById('tttRestart').style.display = 'block';
                        checkTicTacToeEnd();
                    } else if(tttBoard.every(cell => cell !== "")) {
                        tttGameActive = false;
                        document.getElementById('tttStatus').textContent = "Draw!";
                        document.getElementById('tttStatus').style.display = 'block';
                        document.getElementById('tttRestart').style.display = 'block';
                    } else {
                        setTimeout(aiMove, 400);
                    }
                });
                grid.appendChild(cell);
            }
        }

        // --- AI with mistakes ---
        function aiMove() {
            if(!tttGameActive) return;
            // 60% шанс зробити кращий хід, 40% - випадковий хід
            let move;
            if (Math.random() < 0.6) {
                move = findBestMove(tttAI) || findBestMove(tttHuman);
                if (move === null || move === undefined) {
                    // Вибрати випадкову вільну клітинку
                    let free = [];
                    for(let i=0;i<9;i++) if(tttBoard[i]==="") free.push(i);
                    move = free[Math.floor(Math.random()*free.length)];
                }
            } else {
                // Випадковий хід
                let free = [];
                for(let i=0;i<9;i++) if(tttBoard[i]==="") free.push(i);
                move = free[Math.floor(Math.random()*free.length)];
            }
            if(move !== undefined) tttBoard[move] = tttAI;
            tttCurrent = "human";
            drawTicTacToe();
            if(checkTicTacToeWin(tttAI)) {
                tttGameActive = false;
                document.getElementById('tttFail').textContent = `AI wins! (${tttHumanWins}/${tttAttempts} wins)`;
                document.getElementById('tttFail').style.display = 'block';
                document.getElementById('tttRestart').style.display = 'block';
                checkTicTacToeEnd();
            } else if(tttBoard.every(cell => cell !== "")) {
                tttGameActive = false;
                document.getElementById('tttStatus').textContent = "Draw!";
                document.getElementById('tttStatus').style.display = 'block';
                document.getElementById('tttRestart').style.display = 'block';
            }
        }

        function findBestMove(player) {
            // Return index to win/block if possible
            const wins = [
                [0,1,2],[3,4,5],[6,7,8],
                [0,3,6],[1,4,7],[2,5,8],
                [0,4,8],[2,4,6]
            ];
            for(const line of wins) {
                const [a,b,c] = line;
                const vals = [tttBoard[a], tttBoard[b], tttBoard[c]];
                if(vals.filter(v=>v===player).length===2 && vals.includes("")) {
                    return line[vals.indexOf("")];
                }
            }
            return null;
        }

        function checkTicTacToeWin(player) {
            const wins = [
                [0,1,2],[3,4,5],[6,7,8],
                [0,3,6],[1,4,7],[2,5,8],
                [0,4,8],[2,4,6]
            ];
            return wins.some(line => line.every(i => tttBoard[i] === player));
        }

        function checkTicTacToeEnd() {
            if(tttHumanWins >= 1) {
                document.getElementById('tttStatus').textContent = "Congratulations! You beat the AI!";
                document.getElementById('tttRestart').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('captchaTicTacToeModal').style.display = 'none';
                    openFinalModal();
                }, 1500);
            } else if(tttAttempts >= 3) {
                failCount3++;
                updateFailCounters();
                document.getElementById('tttFail').textContent = "No more attempts! Try again later.";
                document.getElementById('tttRestart').style.display = 'none';
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        }

        document.getElementById('tttRestart').onclick = function() {
            tttAttempts++;
            // If draw, switch starter
            let lastStarter = tttStarter;
            if(document.getElementById('tttStatus').textContent === "Draw!") {
                tttStarter = (tttStarter === "human") ? "ai" : "human";
            }
            resetTicTacToe(tttStarter);
        };
        document.getElementById('closeTicTacToe').onclick = function() {
            document.getElementById('captchaTicTacToeModal').style.display = 'none';
            tttGameActive = false;
        };

        // --- Відкриття гри після Simon ---
        function openTicTacToeAfterSimon() {
            tttAttempts = 1;
            tttHumanWins = 0;
            tttStarter = "ai"; // Перший раунд: бот ходить першим
            resetTicTacToe(tttStarter);
            document.getElementById('captchaTicTacToeModal').style.display = 'flex';
        }

        // --- Фінальна капча ---
        // Кнопка "I am human" може тікати за межі вікна CAPTCHA
        let evadeActive = false, evadeTimeout = null, evadeAnimFrame = null;
        let btnHuman, startLeft, startTop;

        function openFinalModal() {
            document.getElementById('captchaFinalModal').style.display = 'flex';
            btnHuman = document.getElementById('btnHuman');
            btnHuman.style.position = "fixed";
            btnHuman.style.left = "50%";
            btnHuman.style.top = "50%";
            btnHuman.style.transform = "translate(-50%, -50%)";
            startLeft = (window.innerWidth - btnHuman.offsetWidth) / 2;
            startTop = (window.innerHeight - btnHuman.offsetHeight) / 2;
            btnHuman.style.left = startLeft + "px";
            btnHuman.style.top = startTop + "px";
            btnHuman.style.transform = "";
            evadeActive = true;

            // Слідкуємо за мишкою
            document.addEventListener('mousemove', trackMouseGlobal);
            if(evadeAnimFrame) cancelAnimationFrame(evadeAnimFrame);
            evadeAnimFrame = requestAnimationFrame(evadeMoveGlobal);

            // Через 3 секунди кнопка перестає увертатись
            if(evadeTimeout) clearTimeout(evadeTimeout);
            evadeTimeout = setTimeout(() => {
                evadeActive = false;
                document.removeEventListener('mousemove', trackMouseGlobal);
                btnHuman.style.left = startLeft + "px";
                btnHuman.style.top = startTop + 100 + "px";
            }, 10000);
        }

        let mousePosGlobal = {x: window.innerWidth/2, y: window.innerHeight/2};
        function trackMouseGlobal(e) {
            mousePosGlobal.x = e.clientX;
            mousePosGlobal.y = e.clientY;
        }

        function evadeMoveGlobal() {
            if (!evadeActive) return;
            // Поточна позиція кнопки
            let curLeft = parseFloat(btnHuman.style.left);
            let curTop = parseFloat(btnHuman.style.top);

            // Центр кнопки
            let btnCenterX = curLeft + btnHuman.offsetWidth / 2;
            let btnCenterY = curTop + btnHuman.offsetHeight / 2;

            // Відстань до миші
            let dx = btnCenterX - mousePosGlobal.x;
            let dy = btnCenterY - mousePosGlobal.y;
            let dist = Math.sqrt(dx*dx + dy*dy);

            // Якщо миша близько — рухаємо кнопку
            const minDist = 250;
            if (dist < minDist) {
                // Вектор відштовхування
                let angle = Math.atan2(dy, dx);
                let push = (minDist - dist) * 0.18;
                let newLeft = curLeft + Math.cos(angle) * push;
                let newTop = curTop + Math.sin(angle) * push;

                // Межі всього екрану (window)
                const maxLeft = window.innerWidth - btnHuman.offsetWidth - 4;
                const maxTop = window.innerHeight - btnHuman.offsetHeight - 4;
                newLeft = Math.max(2, Math.min(maxLeft, newLeft));
                newTop = Math.max(2, Math.min(maxTop, newTop));

                btnHuman.style.left = newLeft + "px";
                btnHuman.style.top = newTop + "px";
            }
            evadeAnimFrame = requestAnimationFrame(evadeMoveGlobal);
        }

        document.getElementById('btnHuman').addEventListener('click', function() {
            if(evadeActive) return; // Не даємо натискати поки увертається
            window.location.href = "https://www.google.com";
        });

        document.getElementById('btnRobot').addEventListener('click', function() {
            location.reload();
        });

        document.getElementById('closeFinal').onclick = function() {
            document.getElementById('captchaFinalModal').style.display = 'none';
            evadeActive = false;
            document.removeEventListener('mousemove', trackMouseGlobal);
            if(evadeAnimFrame) cancelAnimationFrame(evadeAnimFrame);
        };

        // --- Показати капчу після 2 секунд спінера ---
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('spinnerBox').style.display = 'none';
                document.getElementById('captchaFake').style.display = 'flex';
            }, 2000);
        });

        // Відкриття справжньої капчі по кліку на фейкову
        document.getElementById('captchaFake').addEventListener('click', function() {
            document.getElementById('captchaModal').style.display = 'flex';
            playerPos = findStart();
            document.getElementById('captchaSuccess').style.display = 'none';
            document.getElementById('captchaFail').style.display = 'none';
            drawMaze();
            isModalActive = true;
        });

        let isModalActive = false;

        window.addEventListener('keydown', function(e) {
            if (!isModalActive || document.getElementById('captchaModal').style.display !== 'flex') return;
            let key = e.key.toLowerCase();
            let move = moveKeys[key];
            if (!move) {
                if (e.key === "ArrowUp") move = {dx:0, dy:-1};
                if (e.key === "ArrowDown") move = {dx:0, dy:1};
                if (e.key === "ArrowLeft") move = {dx:-1, dy:0};
                if (e.key === "ArrowRight") move = {dx:1, dy:0};
            }
            if (move) {
                let nx = playerPos.x + move.dx;
                let ny = playerPos.y + move.dy;
                if (nx >= 0 && ny >= 0 && ny < mazeData.length && nx < mazeData[0].length) {
                    movePlayerTo(nx, ny);
                }
                e.preventDefault();
            }
        });
    </script>
</body>
  </html>
