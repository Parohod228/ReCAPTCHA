<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Перевірка завантаження</title>
    <style>
      #failCounter1, #failCounter2, #failCounter3, #failCounter4{display: none;}
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #fff;
            overflow: hidden;
        }
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        .spinner {
            width: 80px;
            height: 80px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 40px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
        .captcha-fake {
            display: flex;
            flex-direction: row;
            align-items: center;
            background: #f9f9f9;
            border: 1px solid #d3d3d3;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            padding: 12px 18px 12px 12px;
            min-width: 320px;
            min-height: 80px;
            position: relative;
            cursor: pointer;
            user-select: none;
            transition: box-shadow 0.2s;
        }
        .captcha-fake:active {
            box-shadow: 0 2px 16px rgba(66,133,244,0.15);
        }
        .captcha-checkbox {
            width: 28px;
            height: 28px;
            border: 2px solid #c1c1c1;
            border-radius: 3px;
            background: #fff;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #4285f4;
            transition: border-color 0.2s;
        }
        .captcha-checkbox.checked {
            border-color: #4285f4;
            background: #e8f0fe;
        }
        .captcha-fake-label {
            font-size: 16px;
            color: #222;
            font-family: Arial, sans-serif;
            margin-right: 18px;
        }
        .captcha-fake-logo {
            width: 32px;
            height: 32px;
            margin-left: auto;
        }
        .captcha-fake-x {
            display: none;
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 22px;
            color: #888;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 2;
        }
        .captcha-fake-x:hover {
            color: #222;
        }
        .captcha-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.35);
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .captcha-window {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.2);
            width: 370px;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            position: relative;
        }
        .captcha-header {
            background: #f9f9f9;
            padding: 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        .captcha-logo {
            width: 32px;
            height: 32px;
            margin-right: 12px;
        }
        .captcha-title {
            font-size: 16px;
            color: #222;
            font-weight: bold;
        }
        .captcha-content {
            padding: 24px 16px 16px 16px;
            text-align: center;
        }
        .maze-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .maze {
            display: grid;
            grid-template-columns: repeat(15, 16px);
            grid-template-rows: repeat(15, 16px);
            gap: 2px;
            margin: 0 auto;
        }
        .maze-cell {
            width: 16px;
            height: 16px;
            background: #e0e0e0;
            border-radius: 4px;
        }
        .maze-wall {
            background: #757575;
        }
        .maze-player {
            background: #4285f4;
        }
        .maze-end {
            background: #34a853;
        }
        .captcha-close {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            font-size: 20px;
            color: #888;
            cursor: pointer;
        }
        .captcha-close:hover {
            color: #222;
        }
        .captcha-footer {
            padding: 12px 16px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
            text-align: right;
        }
        .captcha-success {
            color: #34a853;
            font-weight: bold;
            margin-top: 12px;
        }
        .captcha-fail {
            color: #ea4335;
            font-weight: bold;
            margin-top: 12px;
        }
        #tttRestart {
            display: none;
            margin: 18px auto 0 auto;
            padding: 0 28px;
            height: 36px;
            background: #f1f3f4;
            color: #222;
            border: 1px solid #d3d3d3;
            border-radius: 4px;
            font-size: 15px;
            font-family: Arial, sans-serif;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(60,64,67,0.08);
            transition: background 0.2s, border-color 0.2s;
            display: block;
        }
        #tttRestart:hover {
            background: #e8f0fe;
            border-color: #4285f4;
            color: #174ea6;
        }
        .final-btn {
            background: #f1f3f4;
            color: #222;
            border: 1px solid #d3d3d3;
            border-radius: 4px;
            font-size: 15px;
            font-family: Arial, sans-serif;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(60,64,67,0.08);
            transition: background 0.2s, border-color 0.2s, left 0.2s, top 0.2s;
            height: 38px;
            margin: 0 auto;
            display: block;
            min-width: 120px;
        }
        .final-btn:hover {
            background: #e8f0fe;
            border-color: #4285f4;
            color: #174ea6;
        }
        #captchaFinalModal .captcha-content > div[style*="flex"] {
            position: relative;
            min-height: 120px;
        }
        #btnHuman {
            position: absolute;
            transition: background 0s;
        }
        
        /* Додано стилі для гри "Пошук слів" */
        .word-search-container {
            position: relative;
            display: inline-block;
            margin: 0 auto;
        }
        .word-search-grid {
            display: grid;
            /* Змінено розмір сітки з 12x12 на 10x10 */
            grid-template-columns: repeat(10, 32px);
            grid-template-rows: repeat(10, 32px);
            gap: 2px;
            position: relative;
            user-select: none;
        }
        .word-search-cell {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #222;
            background: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            z-index: 2;
            /* Додати transition для плавної зміни кольору */
            transition: background-color 0.3s ease;
        }
        /* Додати клас для знайдених клітинок */
        .word-search-cell.found {
            color: #fff;
            font-weight: bold;
        }
        .word-search-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .word-list {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .word-item {
            padding: 6px 12px;
            background: #f1f3f4;
            border-radius: 16px;
            font-size: 14px;
            color: #555;
            transition: all 0.3s;
        }
        .word-item.found {
            background: #34a853;
            color: #fff;
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <div id="mainContainer" style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100vw;height:100vh;">
        <div id="spinnerBox">
            <div class="spinner"></div>
        </div>
        <div id="captchaFake" class="captcha-fake" tabindex="0" style="display:none;">
            <div id="captchaCheckbox" class="captcha-checkbox"></div>
            <span class="captcha-fake-label">Я не робот</span>
            <img class="captcha-fake-logo" src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA">
        </div>
    </div>
    
    <!-- Модальне вікно лабіринту перекладено українською -->
    <div class="captcha-modal" id="captchaModal">
        <div class="captcha-window">
            <button class="captcha-close" id="closeCaptcha" aria-label="Закрити">&times;</button>
            <div class="captcha-header">
                <img class="captcha-logo" src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA">
                <!-- Завжди показувати "ReCaptcha" замість назви гри -->
                <div class="captcha-title">ReCaptcha</div>
                <div id="failCounter1" style="position:absolute;top:10px;right:16px;font-size:13px;color:#ea4335;font-weight:bold;">Помилок: 0</div>
            </div>
            <div class="captcha-content">
                <div style="font-size:13px;color:#555;margin-bottom:10px;">Проведіть синій квадрат до зеленого, використовуючи стрілки або WASD/ФЦІВ.</div>
                <div class="maze-container">
                    <div class="maze" id="maze"></div>
                </div>
                <div id="captchaSuccess" class="captcha-success" style="display:none;">Успіх!</div>
                <div id="captchaFail" class="captcha-fail" style="display:none;">Ви програли. Спробуйте ще раз.</div>
            </div>
            <div class="captcha-footer">
                <span style="font-size:11px;color:#888;">Ця сторінка захищена reCAPTCHA</span>
            </div>
        </div>
    </div>
    
    <!-- Модальне вікно Simon перекладено українською -->
    <div class="captcha-modal" id="captchaSimonModal" style="display:none;">
        <div class="captcha-window">
            <button class="captcha-close" id="closeSimon" aria-label="Закрити">&times;</button>
            <div class="captcha-header">
                <img class="captcha-logo" src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA">
                <!-- Завжди показувати "ReCaptcha" замість назви гри -->
                <div class="captcha-title">ReCaptcha</div>
                <div id="failCounter2" style="position:absolute;top:10px;right:16px;font-size:13px;color:#ea4335;font-weight:bold;">Помилок: 0</div>
            </div>
            <div class="captcha-content">
                <div style="font-size:13px;color:#555;margin-bottom:10px;">
                    Запам'ятайте послідовність! Повторіть шаблон, натискаючи квадрати в тому ж порядку.
                </div>
                <div id="simonGrid" style="display:grid;grid-template-columns:repeat(3,48px);grid-template-rows:repeat(3,48px);gap:10px;justify-content:center;margin:0 auto 10px auto;"></div>
                <div id="simonStatus" style="font-size:15px;color:#34a853;display:none;margin-top:10px;">Ви перемогли!</div>
                <div id="simonFail" style="font-size:15px;color:#ea4335;display:none;margin-top:10px;">Неправильно! Спробуйте знову.</div>
                <button id="simonRestart" style="display:none;margin-top:10px;">Перезапустити</button>
            </div>
            <div class="captcha-footer">
                <span style="font-size:11px;color:#888;">Ця сторінка захищена reCAPTCHA</span>
            </div>
        </div>
    </div>
    
    <!-- Модальне вікно хрестиків-ноликів перекладено українською -->
    <div class="captcha-modal" id="captchaTicTacToeModal" style="display:none;">
        <div class="captcha-window">
            <button class="captcha-close" id="closeTicTacToe" aria-label="Закрити">&times;</button>
            <div class="captcha-header" style="position:relative;">
                <img class="captcha-logo" src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA">
                <!-- Завжди показувати "ReCaptcha" замість назви гри -->
                <div class="captcha-title">ReCaptcha</div>
                <div id="failCounter3"
                    style="display:none;position:absolute;top:44px;right:16px;font-size:13px;color:#ea4335;font-weight:bold;z-index:2;">
                    Помилок: 0
                </div>
            </div>
            <div class="captcha-content">
                <div style="font-size:13px;color:#555;margin-bottom:10px;">
                    Переможіть ШІ за 3 спроби! Ви ходите першим. У разі нічиєї, стартуючий змінюється.
                </div>
                <div id="tttGrid" style="display:grid;grid-template-columns:repeat(3,48px);grid-template-rows:repeat(3,48px);gap:10px;justify-content:center;margin:0 auto 10px auto;"></div>
                <div id="tttStatus" style="font-size:15px;color:#34a853;display:none;margin-top:10px;"></div>
                <div id="tttFail" style="font-size:15px;color:#ea4335;display:none;margin-top:10px;"></div>
                <button id="tttRestart" style="display:none;margin-top:10px;">Наступний раунд</button>
            </div>
            <div class="captcha-footer">
                <span style="font-size:11px;color:#888;">Ця сторінка захищена reCAPTCHA</span>
            </div>
        </div>
    </div>
    
    <!-- Додано нове модальне вікно для гри "Пошук слів" -->
    <div class="captcha-modal" id="captchaWordSearchModal" style="display:none;">
        <div class="captcha-window" style="width: 420px;">
            <button class="captcha-close" id="closeWordSearch" aria-label="Закрити">&times;</button>
            <div class="captcha-header">
                <img class="captcha-logo" src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA">
                <!-- Завжди показувати "ReCaptcha" замість назви гри -->
                <div class="captcha-title">ReCaptcha</div>
                <div id="failCounter4" style="position:absolute;top:10px;right:16px;font-size:13px;color:#ea4335;font-weight:bold;">Помилок: 0</div>
            </div>
            <div class="captcha-content">
                <!-- Оновлено текст інструкції - видалено згадку про діагональні слова -->
                <div style="font-size:13px;color:#555;margin-bottom:10px;">
                    Знайдіть всі 5 слів у сітці. Слова можуть бути горизонтальними або вертикальними.
                </div>
                <div class="word-search-container">
                    <canvas id="wordSearchCanvas" class="word-search-overlay"></canvas>
                    <div id="wordSearchGrid" class="word-search-grid"></div>
                </div>
                 <!-- Повернути список слів замість лічильника -->
                <div id="wordList" class="word-list"></div>
                <div id="wordSearchSuccess" class="captcha-success" style="display:none;">Вітаємо! Ви знайшли всі слова!</div>
                <div id="wordSearchFail" class="captcha-fail" style="display:none;">Спробуйте ще раз!</div>
            </div>
            <div class="captcha-footer">
                <span style="font-size:11px;color:#888;">Ця сторінка захищена reCAPTCHA</span>
            </div>
        </div>
    </div>
    
    <!-- Фінальне модальне вікно перекладено українською -->
    <div class="captcha-modal" id="captchaFinalModal" style="display:none;">
        <div class="captcha-window">
            <button class="captcha-close" id="closeFinal" aria-label="Закрити">&times;</button>
            <div class="captcha-header">
                <img class="captcha-logo" src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA">
                <!-- Завжди показувати "ReCaptcha" замість назви гри -->
                <div class="captcha-title">ReCaptcha</div>
            </div>
            <div class="captcha-content">
                <div style="font-size:16px;color:#222;font-weight:bold;margin-bottom:24px;">Ви людина?</div>
                <div style="display:flex;flex-direction:column;align-items:center;gap:18px;">
                    <button id="btnRobot" class="final-btn" style="width:180px;">Я робот</button>
                    <button id="btnHuman" class="final-btn" style="width:180px;position:relative;">Я людина</button>
                </div>
            </div>
            <div class="captcha-footer">
                <span style="font-size:11px;color:#888;">Ця сторінка захищена reCAPTCHA</span>
            </div>
        </div>
    </div>

    <script>
        
        // Управління WASD (UA/EN) та ФЦІВ (UA)
        const moveKeys = {
            // English
            'w': {dx:0, dy:-1},
            'a': {dx:-1, dy:0},
            's': {dx:0, dy:1},
            'd': {dx:1, dy:0},
            // Українська ФЦІВ
            'ф': {dx:-1, dy:0},
            'ц': {dx:0, dy:-1},
            'і': {dx:0, dy:1},
            'в': {dx:1, dy:0},
        };
        
        
        // Генерація лабіринту
        function generateMaze(width, height) {
            let maze = Array.from({length: height}, () => Array(width).fill(0));
            function carve(x, y) {
                maze[y][x] = 1;
                const dirs = [
                    [0, -2], [0, 2], [-2, 0], [2, 0]
                ].sort(() => Math.random() - 0.5);
                for (const [dx, dy] of dirs) {
                    const nx = x + dx, ny = y + dy;
                    if (ny > 0 && ny < height && nx > 0 && nx < width && maze[ny][nx] === 0) {
                        maze[y + dy/2][x + dx/2] = 1;
                        carve(nx, ny);
                    }
                }
            }
            carve(1, 1);
            maze[1][1] = 2;
            maze[height-2][width-2] = 3;
            return maze;
        }

        const MAZE_SIZE = 21;
        let mazeData = generateMaze(MAZE_SIZE, MAZE_SIZE);
        let playerPos = {x:1, y:1};

        function findStart() {
            for(let y=0; y<mazeData.length; y++) {
                for(let x=0; x<mazeData[0].length; x++) {
                    if(mazeData[y][x] === 2) return {x, y};
                }
            }
            return {x:1, y:1};
        }

        function drawMaze() {
            const maze = document.getElementById('maze');
            maze.innerHTML = '';
            let viewSize = 15;
            let half = Math.floor(viewSize/2);
            
            // Обчислити бажану позицію камери
            let startX = playerPos.x - half;
            let startY = playerPos.y - half;
            let endX = playerPos.x + half;
            let endY = playerPos.y + half;
            
            // Обмежити view до меж лабіринту [0, 20]
            if (startX < 0) {
                startX = 0;
                endX = viewSize - 1;
            }
            if (startY < 0) {
                startY = 0;
                endY = viewSize - 1;
            }
            if (endX > MAZE_SIZE - 1) {
                endX = MAZE_SIZE - 1;
                startX = MAZE_SIZE - viewSize;
            }
            if (endY > MAZE_SIZE - 1) {
                endY = MAZE_SIZE - 1;
                startY = MAZE_SIZE - viewSize;
            }
            
            // Зупинити камеру коли гравець за 2 блоки від краю
            // Ліва межа: якщо гравець на позиції 2 або менше, камера не рухається лівіше
            if (playerPos.x <= 2) {
                startX = 0;
            }
            // Права межа: якщо гравець на позиції 18 або більше, камера не рухається правіше
            if (playerPos.x >= MAZE_SIZE - 3) {
                startX = MAZE_SIZE - viewSize;
            }
            // Верхня межа: якщо гравець на позиції 2 або менше, камера не рухається вище
            if (playerPos.y <= 2) {
                startY = 0;
            }
            // Нижня межа: якщо гравець на позиції 18 або більше, камера не рухається нижче
            if (playerPos.y >= MAZE_SIZE - 3) {
                startY = MAZE_SIZE - viewSize;
            }
            // </CHANGE>
            
            maze.style.gridTemplateColumns = `repeat(${viewSize}, 16px)`;
            maze.style.gridTemplateRows = `repeat(${viewSize}, 16px)`;
            for(let y=0; y<viewSize; y++) {
                for(let x=0; x<viewSize; x++) {
                    let mx = startX + x, my = startY + y;
                    const cell = document.createElement('div');
                    cell.classList.add('maze-cell');
                    if (my >= mazeData.length || mx >= mazeData[0].length) {
                        cell.classList.add('maze-wall');
                    } else {
                        if(mazeData[my][mx] === 0) cell.classList.add('maze-wall');
                        if(mazeData[my][mx] === 3) cell.classList.add('maze-end');
                        if(playerPos.x === mx && playerPos.y === my) cell.classList.add('maze-player');
                    }
                    maze.appendChild(cell);
                }
            }
        }

        function updateMaze() {
            drawMaze();
        }

        function isValidMove(x, y) {
            return x >= 0 && y >= 0 && y < mazeData.length && x < mazeData[0].length && mazeData[y][x] !== 0;
        }

        function movePlayerTo(x, y) {
            if (mazeData[y][x] === 0) {
                document.getElementById('captchaFail').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('captchaFail').style.display = 'none';
                    playerPos = findStart();
                    drawMaze();
                }, 900);
                return false;
            } else {
                playerPos.x = x;
                playerPos.y = y;
                updateMaze();
                checkWin();
                return true;
            }
        }

        function checkWin() {
            if(mazeData[playerPos.y][playerPos.x] === 3) {
                document.getElementById('captchaSuccess').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('captchaModal').style.display = 'none';
                    isModalActive = false;
                    document.getElementById('captchaSimonModal').style.display = 'flex';
                    startSimonGame();
                }, 1000);
            }
        }

        let failCount1 = 0, failCount2 = 0, failCount3 = 0, failCount4 = 0;

        function updateFailCounters() {
            document.getElementById('failCounter1').textContent = `Помилок: ${failCount1}`;
            document.getElementById('failCounter2').textContent = `Помилок: ${failCount2}`;
            document.getElementById('failCounter3').textContent = `Помилок: ${failCount3}`;
            document.getElementById('failCounter4').textContent = `Помилок: ${failCount4}`;
        }

        function failCaptcha() {
            failCount1++;
            updateFailCounters();
            document.getElementById('captchaFail').style.display = 'block';
            setTimeout(() => {
                location.reload();
            }, 1200);
        }

        function simonFailReload() {
            failCount2++;
            updateFailCounters();
            document.getElementById('simonFail').style.display = 'block';
            setTimeout(() => {
                location.reload();
            }, 1200);
        }

        // --- Simon/Memory Game ---
        let simonSequence = [];
        let simonStep = 0;
        let simonActive = false;
        let simonClickable = false;
        const simonGrid = [];
        const simonColors = [
            "#e0e0e0", "#e0e0e0", "#e0e0e0",
            "#e0e0e0", "#e0e0e0", "#e0e0e0",
            "#e0e0e0", "#e0e0e0", "#e0e0e0"
        ];
        const simonActiveColor = "#4285f4";

        function randomSimonCell() {
            return Math.floor(Math.random() * 9);
        }

        function startSimonGame() {
            simonSequence = [randomSimonCell()];
            simonStep = 0;
            simonActive = true;
            document.getElementById('simonStatus').style.display = 'none';
            document.getElementById('simonFail').style.display = 'none';
            document.getElementById('simonRestart').style.display = 'none';
            drawSimonGrid();
            showSimonSequence();
        }

        function showSimonSequence() {
            simonClickable = false;
            let i = 0;
            let clickCounts = Array(9).fill(0);
            for (let idx of simonSequence) clickCounts[idx]++;
            if (simonSequence.length > 1) {
                let totalClips = simonSequence.length;
                if (totalClips >= 6) {
                    document.getElementById('simonStatus').textContent = "Ви перемогли!";
                    document.getElementById('simonStatus').style.display = 'block';
                    simonActive = false;
                    setTimeout(() => {
                        document.getElementById('captchaSimonModal').style.display = 'none';
                        openTicTacToeAfterSimon();
                    }, 1200);
                    return;
                }
            }
            function highlight() {
                if(i < simonSequence.length) {
                    let idx = simonSequence[i];
                    simonGrid[idx].style.background = simonActiveColor;
                    setTimeout(() => {
                        simonGrid[idx].style.background = simonColors[idx];
                        i++;
                        setTimeout(highlight, 250);
                    }, 400);
                } else {
                    simonClickable = true;
                }
            }
            setTimeout(highlight, 400);
        }

        function drawSimonGrid() {
            const grid = document.getElementById('simonGrid');
            grid.innerHTML = '';
            simonGrid.length = 0;
            for(let i=0;i<9;i++) {
                const cell = document.createElement('div');
                cell.style.width = "48px";
                cell.style.height = "48px";
                cell.style.background = simonColors[i];
                cell.style.borderRadius = "8px";
                cell.style.cursor = simonClickable ? "pointer" : "default";
                cell.style.boxShadow = "0 1px 4px rgba(0,0,0,0.08)";
                cell.addEventListener('click', () => {
                    if(!simonClickable || !simonActive) return;
                    if(i === simonSequence[simonStep]) {
                        cell.style.background = simonActiveColor;
                        setTimeout(() => {
                            cell.style.background = simonColors[i];
                        }, 200);
                        simonStep++;
                        if(simonStep === simonSequence.length) {
                            let clickCounts = Array(9).fill(0);
                            for (let idx of simonSequence) clickCounts[idx]++;
                            let totalClips = simonSequence.length;
                            if (totalClips >= 6) {
                                document.getElementById('simonStatus').textContent = "Ви перемогли!";
                                document.getElementById('simonStatus').style.display = 'block';
                                simonActive = false;
                                setTimeout(() => {
                                    document.getElementById('captchaSimonModal').style.display = 'none';
                                    openTicTacToeAfterSimon();
                                }, 1200);
                            } else {
                                simonStep = 0;
                                simonSequence.push(randomSimonCell());
                                setTimeout(showSimonSequence, 700);
                            }
                        }
                    } else {
                        simonFailReload();
                    }
                });
                simonGrid.push(cell);
                grid.appendChild(cell);
            }
        }

        document.getElementById('simonRestart').onclick = startSimonGame;
        document.getElementById('closeSimon').onclick = function() {
            document.getElementById('captchaSimonModal').style.display = 'none';
            simonActive = false;
        };

        // --- Tic-Tac-Toe ---
        let tttBoard, tttHuman, tttAI, tttCurrent, tttAttempts, tttHumanWins, tttStarter, tttGameActive;

        function resetTicTacToe(starter = "ai") {
            tttBoard = Array(9).fill("");
            tttHuman = "X";
            tttAI = "O";
            tttCurrent = starter;
            tttStarter = starter;
            tttGameActive = true;
            document.getElementById('tttStatus').style.display = 'none';
            document.getElementById('tttFail').style.display = 'none';
            document.getElementById('tttRestart').style.display = 'none';
            updateFailCounters();
            drawTicTacToe();
            if (tttCurrent === "ai") setTimeout(aiMove, 400);
        }

        function drawTicTacToe() {
            const grid = document.getElementById('tttGrid');
            grid.innerHTML = '';
            for(let i=0;i<9;i++) {
                const cell = document.createElement('div');
                cell.style.width = "48px";
                cell.style.height = "48px";
                cell.style.background = "#e0e0e0";
                cell.style.borderRadius = "8px";
                cell.style.cursor = (tttCurrent === "human" && tttBoard[i] === "" && tttGameActive) ? "pointer" : "default";
                cell.style.boxShadow = "0 1px 4px rgba(0,0,0,0.08)";
                cell.style.display = "flex";
                cell.style.alignItems = "center";
                cell.style.justifyContent = "center";
                cell.style.fontSize = "32px";
                cell.style.fontWeight = "bold";
                if (tttBoard[i] === "X") {
                    cell.style.color = "#ea4335";
                } else if (tttBoard[i] === "O") {
                    cell.style.color = "#4285f4";
                } else {
                    cell.style.color = "#222";
                }
                cell.textContent = tttBoard[i];
                cell.addEventListener('click', () => {
                    if(tttCurrent !== "human" || tttBoard[i] !== "" || !tttGameActive) return;
                    tttBoard[i] = tttHuman;
                    tttCurrent = "ai";
                    drawTicTacToe();
                    if(checkTicTacToeWin(tttHuman)) {
                        tttHumanWins++;
                        tttGameActive = false;
                        document.getElementById('tttStatus').textContent = `Ви перемогли! (${tttHumanWins}/${tttAttempts} перемог)`;
                        document.getElementById('tttStatus').style.display = 'block';
                        document.getElementById('tttRestart').style.display = 'block';
                        checkTicTacToeEnd();
                    } else if(tttBoard.every(cell => cell !== "")) {
                        tttGameActive = false;
                        document.getElementById('tttStatus').textContent = "Нічия!";
                        document.getElementById('tttStatus').style.display = 'block';
                        document.getElementById('tttRestart').style.display = 'block';
                    } else {
                        setTimeout(aiMove, 400);
                    }
                });
                grid.appendChild(cell);
            }
        }

        function aiMove() {
            if(!tttGameActive) return;
            let move;
            if (Math.random() < 0.6) {
                move = findBestMove(tttAI) || findBestMove(tttHuman);
                if (move === null || move === undefined) {
                    let free = [];
                    for(let i=0;i<9;i++) if(tttBoard[i]==="") free.push(i);
                    move = free[Math.floor(Math.random()*free.length)];
                }
            } else {
                let free = [];
                for(let i=0;i<9;i++) if(tttBoard[i]==="") free.push(i);
                move = free[Math.floor(Math.random()*free.length)];
            }
            if(move !== undefined) tttBoard[move] = tttAI;
            tttCurrent = "human";
            drawTicTacToe();
            if(checkTicTacToeWin(tttAI)) {
                tttGameActive = false;
                document.getElementById('tttFail').textContent = `ШІ переміг! (${tttHumanWins}/${tttAttempts} перемог)`;
                document.getElementById('tttFail').style.display = 'block';
                document.getElementById('tttRestart').style.display = 'block';
                checkTicTacToeEnd();
            } else if(tttBoard.every(cell => cell !== "")) {
                tttGameActive = false;
                document.getElementById('tttStatus').textContent = "Нічия!";
                document.getElementById('tttStatus').style.display = 'block';
                document.getElementById('tttRestart').style.display = 'block';
            }
        }

        function findBestMove(player) {
            const wins = [
                [0,1,2],[3,4,5],[6,7,8],
                [0,3,6],[1,4,7],[2,5,8],
                [0,4,8],[2,4,6]
            ];
            for(const line of wins) {
                const [a,b,c] = line;
                const vals = [tttBoard[a], tttBoard[b], tttBoard[c]];
                if(vals.filter(v=>v===player).length===2 && vals.includes("")) {
                    return line[vals.indexOf("")];
                }
            }
            return null;
        }

        function checkTicTacToeWin(player) {
            const wins = [
                [0,1,2],[3,4,5],[6,7,8],
                [0,3,6],[1,4,7],[2,5,8],
                [0,4,8],[2,4,6]
            ];
            return wins.some(line => line.every(i => tttBoard[i] === player));
        }

        function checkTicTacToeEnd() {
            if(tttHumanWins >= 1) {
                document.getElementById('tttStatus').textContent = "Вітаємо! Ви перемогли ШІ!";
                document.getElementById('tttRestart').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('captchaTicTacToeModal').style.display = 'none';
                    openWordSearchGame();
                }, 1500);
            } else if(tttAttempts >= 3) {
                failCount3++;
                updateFailCounters();
                document.getElementById('tttFail').textContent = "Більше немає спроб! Спробуйте пізніше.";
                document.getElementById('tttRestart').style.display = 'none';
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        }

        document.getElementById('tttRestart').onclick = function() {
            tttAttempts++;
            let lastStarter = tttStarter;
            if(document.getElementById('tttStatus').textContent === "Нічия!") {
                tttStarter = (tttStarter === "human") ? "ai" : "human";
            }
            resetTicTacToe(tttStarter);
        };
        document.getElementById('closeTicTacToe').onclick = function() {
            document.getElementById('captchaTicTacToeModal').style.display = 'none';
            tttGameActive = false;
        };

        function openTicTacToeAfterSimon() {
            tttAttempts = 1;
            tttHumanWins = 0;
            tttStarter = "ai";
            resetTicTacToe(tttStarter);
            document.getElementById('captchaTicTacToeModal').style.display = 'flex';
        }

        let wordSearchGrid = [];
        let wordSearchWords = [];
        let wordSearchFoundWords = [];
        let wordSearchSelecting = false;
        let wordSearchSelection = [];
        let wordSearchCanvas, wordSearchCtx;
        let wordSearchWordColors = {};
        
        const ukrainianLetters = 'АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЮЯ';
        const brightColors = [
            '#FF9A56', // яскравий помаранчевий
            '#FF6B9D', // коралово-рожевий
            '#4ECDC4', // бірюзовий
            '#A78BFA', // фіолетовий
            '#FCD34D'  // золотистий
        ];
        
        const commonWords = [
            // 4 букви
            'ЗОРЯ', 'ВОДА', 'НЕБО', 'ПОЛЕ', 'ГОРА',
            'ДРУГ', 'УРОК', 'МЕТА', 'ВІРА', 'ДОЛЯ',
            'ДЕНЬ', 'ПТАХ', 'ЗВІР', 'РИБА', 'ЗВУК',
            'СНІГ', 'ГРАД', 'ШЛЯХ', 'ВІРШ', 'РИМА',
            'СЕЛО', 'ЛІС', 'МОРЕ', 'ОЗЕРО', 'РІЧКА',
            'ЗИМА', 'ЛІТО', 'НІЖЬ', 'ВОЛЯ', 'СИЛА',
            'МАТИ', 'ДІТИ', 'РУКА', 'НОГА', 'ТІЛО',
            'ХЛІБ', 'СІЛЬ', 'ВИНО', 'ПИВО', 'КАВА',
            'СТІЛ', 'СТУЛ', 'ДВІР', 'ПАРК', 'СКВЕР',
            // 5 букв
            'ЛЮБОВ', 'МРІЯ', 'СЛОВО', 'ЗЕМЛЯ', 'ВІТЕР',
            'КНИГА', 'ТАНЕЦЬ', 'ПІСНЯ', 'СОНЦЕ', 'МІСЯЦЬ',
            'ХМАРА', 'ВЕСНА', 'ОСІНЬ', 'КВІТКА', 'ДЕРЕВО',
            'КРИЛО', 'КОЛІР', 'БАРВА', 'ГОЛОС', 'ЗАПАХ',
            'ТЕПЛО', 'ХОЛОД', 'МОРОЗ', 'ТУМАН', 'ХВИЛЯ',
            'ПОТІК', 'КАЗКА', 'ОБРАЗ', 'ШКОЛА', 'ДУМКА',
            'ІДЕЯ', 'НАДІЯ', 'ЩАСТЯ', 'ЖИТТЯ', 'СВІТЛО',
            'ПРАВДА', 'ЧЕСТЬ', 'СЛАВА', 'НАРОД', 'МІСТО',
            'РАНОК', 'ВЕЧІР', 'ЗІРКА', 'ІСКРА', 'СКЕЛЯ',
            'ПІСОК', 'ТРАВА', 'ЛИСТЯ', 'ГІЛКА', 'КАМІНЬ',
            'ВОГОНЬ', 'ГРІМ', 'ДОРОГА', 'ВУЛИЦЯ', 'БУДИНОК',
            // 6 букв
            'ПОШУК', 'МУЗИКА', 'РАДІСТЬ', 'ДИТИНА', 'БАТЬКО',
            'РОБОТА', 'СПРАВА', 'УСПІХ', 'ЗНАННЯ', 'КРАЇНА', 'СВОБОДА',
            'КОСМОС', 'ПЛАНЕТА', 'КОРІНЬ', 'ПТАШКА', 'ТВАРИНА',
            'КОМАХА', 'БДЖОЛА', 'АРОМАТ', 'ПАХОЩІ', 'МЕЛОДІЯ',
            'СТЕЖКА', 'МАНДРИ', 'ЛЕГЕНДА', 'ІСТОРІЯ', 'ПОЕЗІЯ',
            'КАРТИНА', 'МАЛЮНОК', 'УЧЕНЬ', 'ВЧИТЕЛЬ'
        ].filter(word => word.length >= 4 && word.length <= 6);
        
        const biologicalTerms = [
            // 4 букви
            'ГЕНОМ', 'МІТОЗ',
            // 5 букв
            'БІЛОК', 'НЕЙРОН', 'ВІРУС',
            // 6 букв
            'КЛІТИНА', 'СИНАПС', 'МУТАЦІЯ'
        ].filter(word => word.length >= 4 && word.length <= 6);
        
        function getRandomLetter() {
            return ukrainianLetters[Math.floor(Math.random() * ukrainianLetters.length)];
        }
        
        
        function openWordSearchGame() {
            document.getElementById('captchaWordSearchModal').style.display = 'flex';
            initWordSearch();
        }
        
        function initWordSearch() {
            wordSearchGrid = Array(10).fill(null).map(() => Array(10).fill(''));
            
            const shuffledBio = [...biologicalTerms].sort(() => Math.random() - 0.5);
            const shuffledCommon = [...commonWords].sort(() => Math.random() - 0.5);
            
            const numBioWords = Math.min(2, Math.floor(Math.random() * 3)); // 0, 1, або 2
            const numCommonWords = 5 - numBioWords;
            
            wordSearchWords = [
                ...shuffledBio.slice(0, numBioWords),
                ...shuffledCommon.slice(0, numCommonWords)
            ];
            // </CHANGE>
            
            wordSearchFoundWords = [];
            wordSearchSelection = [];
            wordSearchWordColors = {};
            wordSearchWords.forEach((word, index) => {
                wordSearchWordColors[word] = brightColors[index % brightColors.length];
            });
            
            // Розмістити слова
            for (let word of wordSearchWords) {
                placeWord(word);
            }
            
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    if (wordSearchGrid[i][j] === '') {
                        wordSearchGrid[i][j] = getRandomLetter();
                    }
                }
            }
            // </CHANGE>
            
            drawWordSearchGrid();
            drawWordList();
            setupCanvas();
        }
        
        function placeWord(word) {
            const directions = [
                {dx: 1, dy: 0},   // горизонтально вправо
                {dx: 0, dy: 1},   // вертикально вниз
            ];
            
            let placed = false;
            let attempts = 0;
            
            while (!placed && attempts < 100) {
                const dir = directions[Math.floor(Math.random() * directions.length)];
                const startRow = Math.floor(Math.random() * 10);
                const startCol = Math.floor(Math.random() * 10);
                // </CHANGE>
                
                if (canPlaceWord(word, startRow, startCol, dir)) {
                    for (let i = 0; i < word.length; i++) {
                        const row = startRow + i * dir.dy;
                        const col = startCol + i * dir.dx;
                        wordSearchGrid[row][col] = word[i];
                    }
                    placed = true;
                }
                attempts++;
            }
        }
        
        function canPlaceWord(word, startRow, startCol, dir) {
            for (let i = 0; i < word.length; i++) {
                const row = startRow + i * dir.dy;
                const col = startCol + i * dir.dx;
                
                if (row < 0 || row >= 10 || col < 0 || col >= 10) {
                    return false;
                }
                // </CHANGE>
                
                if (wordSearchGrid[row][col] !== '' && wordSearchGrid[row][col] !== word[i]) {
                    return false;
                }
            }
            return true;
        }
        
        function drawWordSearchGrid() {
            const grid = document.getElementById('wordSearchGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'word-search-cell';
                    cell.textContent = wordSearchGrid[i][j];
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    
                    cell.addEventListener('mousedown', startSelection);
                    cell.addEventListener('mouseenter', continueSelection);
                    cell.addEventListener('mouseup', endSelection);
                    
                    grid.appendChild(cell);
                }
            }
            // </CHANGE>
        }

        function startSelection(e) {
            wordSearchSelecting = true;
            wordSearchSelection = [];
            const row = parseInt(e.target.dataset.row);
            const col = parseInt(e.target.dataset.col);
            wordSearchSelection.push({row, col, letter: wordSearchGrid[row][col]});
            
            // Тимчасово підсвітити першу клітинку
            const tempColor = '#D1D5DB'; // сірий для тимчасового виділення
            highlightCells(wordSearchSelection, tempColor, true);
        }
        
        function continueSelection(e) {
            if (!wordSearchSelecting) return;
            
            const row = parseInt(e.target.dataset.row);
            const col = parseInt(e.target.dataset.col);
            
            // Перевірити, чи клітинка вже в виборі
            const alreadySelected = wordSearchSelection.some(cell => cell.row === row && cell.col === col);
            if (alreadySelected) return;
            
            // Якщо це друга клітинка, просто додати
            if (wordSearchSelection.length === 1) {
                wordSearchSelection.push({row, col, letter: wordSearchGrid[row][col]});
                const tempColor = '#D1D5DB';
                highlightCells(wordSearchSelection, tempColor, true);
            } else if (wordSearchSelection.length >= 2) {
                // Перевірити, чи нова клітинка в лінії з попередніми
                const start = wordSearchSelection[0];
                const newCell = {row, col, letter: wordSearchGrid[row][col]};
                
                if (isInLine(start, wordSearchSelection[wordSearchSelection.length - 1], newCell)) {
                    wordSearchSelection.push(newCell);
                    const tempColor = '#D1D5DB';
                    highlightCells(wordSearchSelection, tempColor, true);
                }
            }
        }
        
        function endSelection(e) {
            if (!wordSearchSelecting) return;
            wordSearchSelecting = false;
            
            // Отримати слово з виділених клітинок
            const selectedWord = wordSearchSelection.map(cell => cell.letter).join('');
            
            // Перевірити, чи це правильне слово
            if (wordSearchWords.includes(selectedWord) && !wordSearchFoundWords.includes(selectedWord)) {
                // Правильне слово знайдено!
                wordSearchFoundWords.push(selectedWord);
                const color = wordSearchWordColors[selectedWord];
                
                // Постійно підсвітити клітинки
                highlightCells(wordSearchSelection, color, false);
                
                // Оновити список слів
                drawWordList();
                
                // Перевірити, чи всі слова знайдено
                if (wordSearchFoundWords.length === wordSearchWords.length) {
                    document.getElementById('wordSearchSuccess').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('captchaWordSearchModal').style.display = 'none';
                        openFinalModal();
                    }, 1500);
                }
            } else {
                // Неправильне слово - очистити тимчасове виділення
                clearTemporaryHighlight();
            }
            
            wordSearchSelection = [];
        }
        
        function isInLine(start, middle, end) {
            // Перевірка горизонтальної лінії
            if (start.row === middle.row && middle.row === end.row) {
                return true;
            }
            // Перевірка вертикальної лінії
            if (start.col === middle.col && middle.col === end.col) {
                return true;
            }
            return false;
        }
        
        function highlightCells(cells, color, isTemporary) {
            cells.forEach(cell => {
                const cellElement = document.querySelector(
                    `.word-search-cell[data-row="${cell.row}"][data-col="${cell.col}"]`
                );
                if (cellElement) {
                    cellElement.style.backgroundColor = color;
                    if (!isTemporary) {
                        cellElement.classList.add('found');
                    } else {
                        cellElement.dataset.temporary = 'true';
                    }
                }
            });
        }

        function clearTemporaryHighlight() {
            document.querySelectorAll('.word-search-cell[data-temporary="true"]').forEach(cell => {
                if (!cell.classList.contains('found')) {
                    cell.style.backgroundColor = '#f5f5f5';
                }
                delete cell.dataset.temporary;
            });
        }
        
        function setupCanvas() {
            wordSearchCanvas = document.getElementById('wordSearchCanvas');
            wordSearchCtx = wordSearchCanvas.getContext('2d');
            
            const container = document.querySelector('.word-search-container');
            wordSearchCanvas.width = container.offsetWidth;
            wordSearchCanvas.height = container.offsetHeight;
        }
        
        function drawWordList() {
            const list = document.getElementById('wordList');
            list.innerHTML = '';
            
            for (let word of wordSearchWords) {
                const item = document.createElement('div');
                item.className = 'word-item';
                item.textContent = word;
                item.dataset.word = word;
                
                if (wordSearchFoundWords.includes(word)) {
                    item.classList.add('found');
                }
                
                list.appendChild(item);
            }
        }
        

        // --- Фінальна капча ---
        let evadeActive = false, evadeTimeout = null, evadeAnimFrame = null;
        let btnHuman, startLeft, startTop;

        function openFinalModal() {
            document.getElementById('captchaFinalModal').style.display = 'flex';
            btnHuman = document.getElementById('btnHuman');
            btnHuman.style.position = "fixed";
            btnHuman.style.left = "50%";
            btnHuman.style.top = "50%";
            btnHuman.style.transform = "translate(-50%, -50%)";
            startLeft = (window.innerWidth - btnHuman.offsetWidth) / 2;
            startTop = (window.innerHeight - btnHuman.offsetHeight) / 2;
            btnHuman.style.left = startLeft + "px";
            btnHuman.style.top = startTop + "px";
            btnHuman.style.transform = "";
            evadeActive = true;

            document.addEventListener('mousemove', trackMouseGlobal);
            if(evadeAnimFrame) cancelAnimationFrame(evadeAnimFrame);
            evadeAnimFrame = requestAnimationFrame(evadeMoveGlobal);

            if(evadeTimeout) clearTimeout(evadeTimeout);
            evadeTimeout = setTimeout(() => {
                evadeActive = false;
                document.removeEventListener('mousemove', trackMouseGlobal);
            }, 10000);
            // </CHANGE>
        }

        let mousePosGlobal = {x: window.innerWidth/2, y: window.innerHeight/2};
        function trackMouseGlobal(e) {
            mousePosGlobal.x = e.clientX;
            mousePosGlobal.y = e.clientY;
        }

        function evadeMoveGlobal() {
            if (!evadeActive) return;
            let curLeft = parseFloat(btnHuman.style.left);
            let curTop = parseFloat(btnHuman.style.top);

            let btnCenterX = curLeft + btnHuman.offsetWidth / 2;
            let btnCenterY = curTop + btnHuman.offsetHeight / 2;

            let dx = btnCenterX - mousePosGlobal.x;
            let dy = btnCenterY - mousePosGlobal.y;
            let dist = Math.sqrt(dx*dx + dy*dy);

            const minDist = 250;
            if (dist < minDist) {
                let angle = Math.atan2(dy, dx);
                let push = (minDist - dist) * 0.18;
                let newLeft = curLeft + Math.cos(angle) * push;
                let newTop = curTop + Math.sin(angle) * push;

                const maxLeft = window.innerWidth - btnHuman.offsetWidth - 4;
                const maxTop = window.innerHeight - btnHuman.offsetHeight - 4;
                newLeft = Math.max(2, Math.min(maxLeft, newLeft));
                newTop = Math.max(2, Math.min(maxTop, newTop));

                btnHuman.style.left = newLeft + "px";
                btnHuman.style.top = newTop + "px";
            }
            evadeAnimFrame = requestAnimationFrame(evadeMoveGlobal);
        }

        document.getElementById('btnHuman').addEventListener('click', function() {
            if(evadeActive) return;
            window.location.href = "https://www.google.com";
        });

        document.getElementById('btnRobot').addEventListener('click', function() {
            location.reload();
        });

        document.getElementById('closeFinal').onclick = function() {
            document.getElementById('captchaFinalModal').style.display = 'none';
            evadeActive = false;
            document.removeEventListener('mousemove', trackMouseGlobal);
            if(evadeAnimFrame) cancelAnimationFrame(evadeAnimFrame);
        };

        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('spinnerBox').style.display = 'none';
                document.getElementById('captchaFake').style.display = 'flex';
            }, 2000);
        });

        document.getElementById('captchaFake').addEventListener('click', function() {
            document.getElementById('captchaModal').style.display = 'flex';
            playerPos = findStart();
            document.getElementById('captchaSuccess').style.display = 'none';
            document.getElementById('captchaFail').style.display = 'none';
            drawMaze();
            isModalActive = true;
        });

        let isModalActive = false;

        window.addEventListener('keydown', function(e) {
            if (!isModalActive || document.getElementById('captchaModal').style.display !== 'flex') return;
            let key = e.key.toLowerCase();
            let move = moveKeys[key];
            if (!move) {
                if (e.key === "ArrowUp") move = {dx:0, dy:-1};
                if (e.key === "ArrowDown") move = {dx:0, dy:1};
                if (e.key === "ArrowLeft") move = {dx:-1, dy:0};
                if (e.key === "ArrowRight") move = {dx:1, dy:0};
            }
            if (move) {
                let nx = playerPos.x + move.dx;
                let ny = playerPos.y + move.dy;
                if (nx >= 0 && ny >= 0 && ny < mazeData.length && nx < mazeData[0].length) {
                    movePlayerTo(nx, ny);
                }
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
